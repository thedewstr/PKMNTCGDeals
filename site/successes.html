<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Successes — PKMNTCGDeals</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        darkMode: 'class',
        theme: { extend: { colors: { brand: { 50:'#eef7ff', 400:'#4e86ff', 600:'#2c6de6' } } } }
      }
    </script>
    <style>
      html, body, header, section, footer { transition: background-color .2s, color .2s, border-color .2s; }
    </style>
  </head>

  <body class="bg-white text-slate-800 dark:bg-slate-900 dark:text-slate-100">
    <!-- Header -->
    <header class="sticky top-0 z-40 backdrop-blur bg-white/70 dark:bg-slate-900/70 border-b border-slate-200/60 dark:border-slate-700">
      <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 flex h-16 items-center justify-between">
        <a href="index.html" class="flex items-center gap-2 font-semibold text-slate-900 dark:text-slate-100">
          <img src="assets/soraball.png" alt="PKMNTCGDeals" width="28" height="28"
               class="h-7 w-7 rounded-full object-cover ring-1 ring-slate-300 dark:ring-slate-700"
               loading="eager" decoding="async" />
          <span>PKMNTCGDeals</span>
        </a>

        <nav class="hidden md:flex items-center gap-6 text-sm">
          <a href="successes.html" class="text-brand-600 dark:text-brand-400 font-semibold">Success gallery</a>
          <a href="about.html" class="hover:text-brand-600 dark:hover:text-brand-400">About</a>
        </nav>

        <div class="flex items-center gap-3">
          <button id="themeToggle" class="rounded-xl border border-slate-300 dark:border-slate-600 px-2.5 py-2 text-slate-700 dark:text-slate-200 hover:bg-slate-50 dark:hover:bg-slate-800" aria-label="Toggle dark mode">
            <svg class="h-5 w-5 block dark:hidden" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><circle cx="12" cy="12" r="4"></circle><path d="M12 2v2m0 16v2M4.93 4.93l1.41 1.41M17.66 17.66l1.41 1.41M2 12h2m16 0h2M4.93 19.07l1.41-1.41M17.66 6.34l1.41-1.41"/></svg>
            <svg class="h-5 w-5 hidden dark:block" viewBox="0 0 24 24" fill="currentColor"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>
          </button>
          <a href="https://whop.com/pkmntcgdeals/?&a=thedewstr" class="inline-block rounded-xl bg-brand-600 px-4 py-2 text-sm font-semibold text-white shadow">Go Premium</a>
        </div>
      </div>
    </header>

    <!-- Main -->
    <main class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 py-10">
      <div class="flex flex-col sm:flex-row sm:items-end sm:justify-between gap-4">
        <div>
          <h1 class="text-2xl sm:text-3xl font-bold tracking-tight">Community wins</h1>
          <p class="mt-2 text-slate-600 dark:text-slate-400">Auto-updated from our success channel.</p>
        </div>
        <div class="flex flex-wrap gap-3">
          <input id="search" placeholder="Search caption or author…" class="w-64 rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-900 px-3 py-2 text-sm" />
          <select id="retailer" class="rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-900 px-3 py-2 text-sm">
            <option value="">All retailers</option>
            <option value="pokemon center">Pokémon Center</option>
            <option value="walmart">Walmart</option>
            <option value="target">Target</option>
            <option value="amazon">Amazon</option>
            <option value="best buy">Best Buy</option>
            <option value="gamestop">GameStop</option>
            <option value="costco">Costco</option>
            <option value="barnes & noble">Barnes & Noble</option>
          </select>
        </div>
      </div>

      <div id="grid" class="mt-6 grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4"></div>
      <div id="empty" class="hidden mt-6 rounded-xl border border-dashed border-slate-300 dark:border-slate-700 p-6 text-slate-500 dark:text-slate-400">No matches.</div>

      <div class="mt-8 text-center">
        <button id="loadMore" class="rounded-xl border border-slate-300 dark:border-slate-600 px-4 py-2 text-sm font-semibold hover:bg-slate-50 dark:hover:bg-slate-800">Load more</button>
      </div>
    </main>

    <footer class="border-t border-slate-200/70 dark:border-slate-800 py-10">
      <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 flex flex-col gap-6">
      </div>
    </footer>

    <!-- Scripts -->
    <script>
      const WORKER_BASE = "https://pkmntcg-deals-api.ryantheshibainu.workers.dev";
      const $ = s => document.querySelector(s);

      // client-side state
      let all = [];          // all items loaded so far
      let filtered = [];     // filtered view of "all"
      let shown = 0;         // how many rendered to the grid
      const page = 24;       // cards per render
      let nextOffset = 0;    // server pagination cursor; null when no more
      const limit = 24;

      const grid  = document.getElementById('grid');
      const empty = document.getElementById('empty');
      const btn   = document.getElementById('loadMore');

      function card(item){
        const el = document.createElement('article');
        el.className = "group rounded-2xl overflow-hidden border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-900 shadow-sm";
        el.innerHTML = `
          <a class="block" href="${item.message_url || '#'}" target="_blank" rel="noopener noreferrer">
            <img loading="lazy" class="h-40 w-full object-cover" alt="" src="${item.image_url}"/>
          </a>
          <div class="p-3">
            <p class="line-clamp-2 text-sm text-slate-700 dark:text-slate-300">${item.caption || ''}</p>
            <div class="mt-2 flex items-center justify-between text-xs text-slate-500 dark:text-slate-400">
              <span>@${item.author || 'member'}</span>
              <time>${new Date(item.timestamp || Date.now()).toLocaleDateString()}</time>
            </div>
          </div>`;
        return el;
      }

      function render(reset=false){
        if (reset) { grid.innerHTML = ""; shown = 0; }
        const slice = filtered.slice(shown, shown + page);
        slice.forEach(i => grid.appendChild(card(i)));
        shown += slice.length;

        const localDone = shown >= filtered.length;
        const remoteDone = nextOffset === null;
        btn.disabled = localDone && remoteDone;
        btn.textContent = (localDone && remoteDone) ? "No more" : "Load more";
        btn.classList.toggle('hidden', localDone && remoteDone);
        empty.classList.toggle('hidden', filtered.length !== 0);
      }

      function applyFilters(reset=true){
        const q = (document.getElementById('search').value || '').toLowerCase().trim();
        const r = (document.getElementById('retailer').value || '').toLowerCase();

        filtered = all.filter(i => {
          const text = ((i.caption||'') + ' ' + (i.author||'')).toLowerCase();
          const retailer = (i.retailer || '').toLowerCase();
          return (!q || text.includes(q)) && (!r || retailer === r);
        });

        render(reset);
      }

      async function loadPage(){
        if (nextOffset === null) return; // nothing to do
        btn.disabled = true; btn.textContent = "Loading…";

        try {
          const res = await fetch(`${WORKER_BASE}/feed?offset=${nextOffset}&limit=${limit}`, { cache: 'no-store' });
          if (!res.ok) throw new Error('feed http ' + res.status);
          const data = await res.json();
          const items = Array.isArray(data.items) ? data.items : [];
          nextOffset = (typeof data.nextOffset === 'number' || data.nextOffset === null) ? data.nextOffset : null;

          // append and re-apply filters without clearing what's already rendered
          all = all.concat(items);
          applyFilters(false);
        } catch (e) {
          console.warn('feed error', e);
        } finally {
          // enable again if there is more to show or more to fetch
          const localDone = shown >= filtered.length;
          const remoteDone = nextOffset === null;
          btn.disabled = localDone && remoteDone;
          btn.textContent = (localDone && remoteDone) ? "No more" : "Load more";
        }
      }

      // button behavior: show more from filtered local items, otherwise fetch next page
      btn.addEventListener('click', async () => {
        if (shown < filtered.length) {
          render(false);
        } else if (nextOffset !== null) {
          await loadPage();
        }
      });

      // Filters
      document.getElementById('search').addEventListener('input', () => applyFilters(true));
      document.getElementById('retailer').addEventListener('change', () => applyFilters(true));

      // Initial load
      document.addEventListener('DOMContentLoaded', () => {
        nextOffset = 0; // start at beginning
        loadPage();     // fetch first page and render
      });
    </script>

    <script>
      (function () {
        const stored = localStorage.getItem('theme');
        const preferDark = stored ? stored === 'dark' : window.matchMedia('(prefers-color-scheme: dark)').matches;
        document.documentElement.classList.toggle('dark', preferDark);
      })();
      const btnTheme = document.getElementById('themeToggle');
      if (btnTheme) btnTheme.addEventListener('click', () => {
        const isDark = document.documentElement.classList.toggle('dark');
        localStorage.setItem('theme', isDark ? 'dark' : 'light');
      });
    </script>
  </body>
</html>
